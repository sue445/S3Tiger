<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XPathEvaluator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">s3tiger</a> &gt; <a href="index.html" class="el_package">net.sue445.s3tiger.internal</a> &gt; <span class="el_source">XPathEvaluator.java</span></div><h1>XPathEvaluator.java</h1><pre class="source lang-java linenums">package net.sue445.s3tiger.internal;

import java.io.IOException;
import java.io.InputStream;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.regex.Pattern;

import javax.xml.namespace.QName;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import javax.xml.xpath.XPathVariableResolver;

import org.slim3.util.StringUtil;
import org.w3c.dom.Document;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * wrapping XPath
 * via {@link http://d.hatena.ne.jp/int128/20100126/1264437133}
 * @author int128
 *
 */
public class XPathEvaluator {
<span class="fc" id="L33">	private static String PROPERTIES_NAME = &quot;name&quot;;</span>

<span class="fc" id="L35">	private static String PROPERTIES_VALUE = &quot;value&quot;;</span>

	private final Document document;

	private final XPath xpath;

	/**
	 * @param stream
	 * @throws SAXException
	 * @throws IOException
	 * @throws ParserConfigurationException
	 */
<span class="fc" id="L47">	public XPathEvaluator(InputStream stream) throws SAXException, IOException, ParserConfigurationException {</span>
<span class="fc" id="L48">		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L49">		document = factory.newDocumentBuilder().parse(stream);</span>
<span class="fc" id="L50">		xpath = XPathFactory.newInstance().newXPath();</span>
<span class="fc" id="L51">	}</span>

	public Iterable&lt;Node&gt; getNodeList(String expression) {
		try {
<span class="fc" id="L55">			final NodeList nodeList = (NodeList) xpath.evaluate(expression, document, XPathConstants.NODESET);</span>
<span class="fc" id="L56">			return new Iterable&lt;Node&gt;() {</span>
				@Override
				public Iterator&lt;Node&gt; iterator() {
<span class="fc" id="L59">					return new Iterator&lt;Node&gt;() {</span>
<span class="fc" id="L60">						private int index = 0;</span>

						@Override
						public boolean hasNext() {
<span class="fc bfc" id="L64" title="All 2 branches covered.">							return index &lt; nodeList.getLength();</span>
						}

						@Override
						public Node next() {
<span class="fc" id="L69">							return nodeList.item(index++);</span>
						}

						@Override
						public void remove() {
<span class="nc" id="L74">							throw new UnsupportedOperationException(&quot;NodeList is read-only&quot;);</span>
						}
					};
				}
			};
<span class="nc" id="L79">		} catch (XPathExpressionException e) {</span>
<span class="nc" id="L80">			throw new RuntimeException(e);</span>
		}
	}

	public Iterable&lt;String&gt; getNodeValueList(String expression) {
		try {
<span class="nc" id="L86">			final NodeList nodeList = (NodeList) xpath.evaluate(expression, document, XPathConstants.NODESET);</span>
<span class="nc" id="L87">			return new Iterable&lt;String&gt;() {</span>
				@Override
				public Iterator&lt;String&gt; iterator() {
<span class="nc" id="L90">					return new Iterator&lt;String&gt;() {</span>
<span class="nc" id="L91">						private int index = 0;</span>

						@Override
						public boolean hasNext() {
<span class="nc bnc" id="L95" title="All 2 branches missed.">							return index &lt; nodeList.getLength();</span>
						}

						@Override
						public String next() {
<span class="nc" id="L100">							return nodeList.item(index++).getNodeValue();</span>
						}

						@Override
						public void remove() {
<span class="nc" id="L105">							throw new UnsupportedOperationException(&quot;NodeList is read-only&quot;);</span>
						}
					};
				}
			};
<span class="nc" id="L110">		} catch (XPathExpressionException e) {</span>
<span class="nc" id="L111">			throw new RuntimeException(e);</span>
		}
	}

	/**
	 *
	 * @param expression
	 * @return
	 */
	public String getString(String expression) {
		try {
<span class="nc" id="L122">			return (String) xpath.evaluate(expression, document, XPathConstants.STRING);</span>
<span class="nc" id="L123">		} catch (XPathExpressionException e) {</span>
<span class="nc" id="L124">			throw new RuntimeException(e);</span>
		}
	}

	/**
	 * get trimed string
	 * @param expression
	 * @return
	 */
	public String getTrimedString(String expression){
<span class="nc" id="L134">		String str = getString(expression);</span>

<span class="nc bnc" id="L136" title="All 2 branches missed.">		if(StringUtil.isEmpty(str)){</span>
<span class="nc" id="L137">			return &quot;&quot;;</span>
		}

<span class="nc" id="L140">		str = Pattern.compile(&quot;(^\\s+|\\s+$)&quot;, Pattern.MULTILINE).matcher(str).replaceAll(&quot;&quot;);</span>

<span class="nc" id="L142">		return str;</span>
	}

	public void setVariable(final Map&lt;QName, Object&gt; variableMap) {
<span class="nc" id="L146">		xpath.setXPathVariableResolver(new XPathVariableResolver() {</span>
			@Override
			public Object resolveVariable(QName variableName) {
<span class="nc" id="L149">				return variableMap.get(variableName);</span>
			}
		});
<span class="nc" id="L152">	}</span>

	/**
	 *
	 * @param expression
	 * @param variableMap
	 * @return
	 */
	public Map&lt;String, String&gt; getProperties(String expression, Map&lt;QName, Object&gt; variableMap){
<span class="pc bpc" id="L161" title="3 of 4 branches missed.">		if(variableMap != null &amp;&amp; variableMap.size() &gt; 0){</span>
<span class="nc" id="L162">			setVariable(variableMap);</span>
		}

<span class="fc" id="L165">		Iterable&lt;Node&gt; nodeList = getNodeList(expression);</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if(nodeList == null){</span>
<span class="nc" id="L167">			return null;</span>
		}

<span class="fc" id="L170">		Map&lt;String, String&gt; map = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">		for(Node node : nodeList){</span>
<span class="fc" id="L172">			NamedNodeMap attr = node.getAttributes();</span>
<span class="fc" id="L173">			String key   = attr.getNamedItem(PROPERTIES_NAME).getNodeValue();</span>
<span class="fc" id="L174">			String value = attr.getNamedItem(PROPERTIES_VALUE).getNodeValue();</span>
<span class="fc" id="L175">			map.put(key, value);</span>
<span class="fc" id="L176">		}</span>

<span class="fc" id="L178">		return map;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>